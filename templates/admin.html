<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Survey Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
</head>
<body>
    <div class="container admin-container">
        <div class="admin-header">
            <h1>{{ config.title }}</h1>
            <p class="response-count">{{ responses|length }} response(s)</p>
            <form action="{{ url_for('clear_all_data') }}" method="POST" style="display: inline; margin-left: 1rem;">
                <button type="submit" class="delete-btn danger-btn" onclick="return confirm('⚠️ This will DELETE ALL responses, avatars, and vibe plans. This cannot be undone. Are you sure?')">Clear All Data</button>
            </form>
        </div>

        {% if responses %}
        <!-- Average Confidence Chart -->
        <div class="chart-section">
            <h2>Average Confidence by Topic</h2>
            <div class="chart-container">
                <canvas id="avgChart"></canvas>
            </div>
        </div>

        <!-- Individual Topic Breakdown with Distribution -->
        <div class="chart-section">
            <h2>Response Distribution by Topic</h2>
            {% for question in config.questions %}
            {% if question.type == 'rating' %}
            <div class="question-breakdown">
                <div class="question-header">
                    <span class="question-title">{{ question.label }}</span>
                    <span class="question-avg">Average: <strong>{{ stats[question.id].average }}</strong> / {{ question.max_rating }} ({{ stats[question.id].count }} responses)</span>
                </div>
                <div class="distribution-grid">
                    {% for value in range(1, question.max_rating + 1) %}
                    <div class="distribution-item">
                        <div class="dist-bar-container">
                            {% set count = stats[question.id].distribution[value] %}
                            {% set total = stats[question.id].count %}
                            {% set pct = (count / total * 100)|int if total > 0 else 0 %}
                            <div class="dist-bar-fill" style="height: {{ pct }}%"></div>
                        </div>
                        <div class="dist-value">{{ value }}</div>
                        <div class="dist-count">{{ count }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- AI Assistant Usage -->
        {% if mc_stats.get('ai_assistant_used') %}
        <div class="chart-section">
            <h2>Have you used an AI coding assistant?</h2>
            <div class="usage-chart-row">
                <div class="usage-chart-container">
                    <canvas id="usageChart"></canvas>
                </div>
                <div class="usage-legend">
                    {% for option, count in mc_stats['ai_assistant_used'].items() %}
                    <div class="legend-item">
                        <span class="legend-color" data-option="{{ option }}"></span>
                        <span class="legend-label">{{ option }}: {{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Generated Avatars -->
        {% if avatars %}
        <div class="avatars-section">
            <div class="avatars-header">
                <h2>Generated Avatars ({{ avatars|length }})</h2>
                <form action="{{ url_for('clear_failed_avatars') }}" method="POST" style="display: inline;">
                    <button type="submit" class="delete-btn" onclick="return confirm('Delete all failed avatars?')">Clear Failed</button>
                </form>
            </div>
            <div class="avatars-grid">
                {% for avatar in avatars %}
                <div class="avatar-card">
                    {% if avatar.image_data %}
                    <a href="{{ url_for('view_avatar', avatar_id=avatar.id) }}" target="_blank">
                        <img src="data:image/png;base64,{{ avatar.image_data }}" alt="Avatar">
                    </a>
                    {% else %}
                    <div class="avatar-placeholder">
                        {% if avatar.status == 'pending' %}Processing...{% else %}Failed{% endif %}
                    </div>
                    {% endif %}
                    <div class="avatar-card-info">
                        <div class="avatar-card-email">{{ avatar.email }}</div>
                        <span class="avatar-card-status {{ avatar.status }}">{{ avatar.status }}</span>
                        {% if avatar.status == 'failed' %}
                        <form action="{{ url_for('delete_avatar', avatar_id=avatar.id) }}" method="POST" style="margin-top: 5px;">
                            <button type="submit" class="delete-btn" style="font-size: 10px; padding: 3px 8px;">Delete</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Word Cloud for App Wishlist -->
        {% if text_responses %}
        <div class="chart-section">
            <h2>Apps People Want to Chat With / Automate</h2>
            <div id="wordcloud-container">
                <canvas id="wordcloud"></canvas>
            </div>
            <div class="text-responses-list">
                {% for text in text_responses %}
                <span class="response-chip">{{ text }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Individual Responses (collapsible) -->
        <div class="responses-section">
            <h2 class="collapsible-header" onclick="toggleResponses()">
                Individual Responses
                <span id="toggle-icon">+</span>
            </h2>
            <div id="responses-list" class="responses-list" style="display: none;">
                {% for response in responses %}
                <div class="response-card">
                    <div class="response-header">
                        <span class="response-id">#{{ response.id }}</span>
                        <span class="response-date">{{ response.submitted_at }}</span>
                        <form action="{{ url_for('delete_response', response_id=response.id) }}" method="POST" class="delete-form">
                            <button type="submit" class="delete-btn" onclick="return confirm('Delete this response?')">Delete</button>
                        </form>
                    </div>
                    <div class="response-data">
                        {% for question in config.questions %}
                        <div class="data-row">
                            <span class="data-label">{{ question.label }}:</span>
                            <span class="data-value">
                                {% if question.type == 'checkbox' %}
                                    {{ response.data.get(question.id, [])|join(', ') or 'None selected' }}
                                {% elif question.type == 'rating' %}
                                    {{ response.data.get(question.id, 'N/A') }} / {{ question.max_rating }}
                                {% else %}
                                    {{ response.data.get(question.id, 'N/A') or 'N/A' }}
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <script>
            // Toggle individual responses
            function toggleResponses() {
                const list = document.getElementById('responses-list');
                const icon = document.getElementById('toggle-icon');
                if (list.style.display === 'none') {
                    list.style.display = 'flex';
                    icon.textContent = '−';
                } else {
                    list.style.display = 'none';
                    icon.textContent = '+';
                }
            }

            // Confidence Chart data
            const labels = [
                {% for question in config.questions %}
                {% if question.type == 'rating' %}
                "{{ question.label[:30] }}...",
                {% endif %}
                {% endfor %}
            ];

            const averages = [
                {% for question in config.questions %}
                {% if question.type == 'rating' %}
                {{ stats[question.id].average }},
                {% endif %}
                {% endfor %}
            ];

            // Create confidence bar chart
            const ctx = document.getElementById('avgChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Confidence',
                        data: averages,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            {% if mc_stats.get('ai_assistant_used') %}
            // AI Assistant Usage Pie Chart
            const usageCtx = document.getElementById('usageChart').getContext('2d');
            new Chart(usageCtx, {
                type: 'doughnut',
                data: {
                    labels: [{% for opt in mc_stats['ai_assistant_used'].keys() %}"{{ opt }}",{% endfor %}],
                    datasets: [{
                        data: [{% for count in mc_stats['ai_assistant_used'].values() %}{{ count }},{% endfor %}],
                        backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Set legend colors
            document.querySelectorAll('.legend-color').forEach((el, i) => {
                const colors = ['#2ecc71', '#e74c3c', '#f39c12'];
                el.style.backgroundColor = colors[i];
            });
            {% endif %}

            {% if text_responses %}
            // Word Cloud
            const textResponses = [
                {% for text in text_responses %}
                "{{ text|replace('"', '\\"') }}",
                {% endfor %}
            ];

            // Count word frequency
            const wordCounts = {};
            textResponses.forEach(text => {
                const words = text.toLowerCase().split(/[\s,]+/);
                words.forEach(word => {
                    word = word.replace(/[^a-zA-Z0-9]/g, '');
                    if (word.length > 2) {
                        wordCounts[word] = (wordCounts[word] || 0) + 1;
                    }
                });
            });

            // Also count full responses for better visualization
            textResponses.forEach(text => {
                const clean = text.trim();
                if (clean) {
                    wordCounts[clean] = (wordCounts[clean] || 0) + 2;
                }
            });

            // Convert to wordcloud format
            const wordList = Object.entries(wordCounts)
                .map(([word, count]) => [word, count * 20])
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50);

            if (wordList.length > 0) {
                const canvas = document.getElementById('wordcloud');
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = 300;

                WordCloud(canvas, {
                    list: wordList,
                    gridSize: 8,
                    weightFactor: 3,
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    color: function() {
                        const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0.3,
                    backgroundColor: 'transparent'
                });
            }
            {% endif %}
        </script>

        {% else %}
        <div class="no-responses">
            <p>No responses yet.</p>
            <a href="{{ url_for('survey') }}" class="btn">Go to Survey</a>
        </div>
        {% endif %}
    </div>
</body>
</html>
